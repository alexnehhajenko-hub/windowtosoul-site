<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>WindowToSoul ‚Äî AI Portrait</title>
<link rel="stylesheet" href="assets/style.css">

<style>
body {
  background: #0b0e1a;
  color: white;
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  padding: 20px;
}

.container {
  max-width: 540px;
  margin: auto;
}

.block {
  background: #111427;
  padding: 22px;
  border-radius: 22px;
  margin-bottom: 25px;
  box-shadow: 0 0 20px rgba(0,0,0,0.3);
}

h1, h2 {
  margin-bottom: 12px;
}

button {
  width: 100%;
  background: linear-gradient(90deg,#a86bff,#e47cff);
  border: none;
  border-radius: 16px;
  padding: 16px;
  font-size: 18px;
  font-weight: bold;
  margin-top: 12px;
  cursor: pointer;
}

#result img {
  width: 100%;
  border-radius: 16px;
  margin-top: 10px;
}

.style-btns {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}

.style-btns button {
  flex: 1 1 calc(50% - 10px);
  background: #1c2036;
  border: 1px solid #333;
  padding: 14px;
  border-radius: 14px;
  font-size: 16px;
}

.style-btns button.active {
  background: #6b46ff;
  border-color: #a184ff;
}
</style>

</head>
<body>

<div class="container">

  <h1>üé® AI ‚Üí Artwork</h1>
  <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å ‚Üí –ø–æ–ª—É—á–∏—Ç–µ –∫—Ä–∞—Å–∏–≤—ã–π –ø–æ—Ä—Ç—Ä–µ—Ç.</p>

  <!-- –ë–õ–û–ö 1 -->
  <div class="block">
    <h2>1. –§–æ—Ç–æ</h2>
    <input type="file" id="photo" accept="image/*">
    <p style="opacity:.7;font-size:14px;margin-top:6px">
      –§–æ—Ç–æ –±—É–¥–µ—Ç —É–º–µ–Ω—å—à–µ–Ω–æ –¥–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ (—Ñ–∏–∫—Å –¥–ª—è –æ—à–∏–±–æ–∫ 413).
    </p>
  </div>

  <!-- –ë–õ–û–ö 2 -->
  <div class="block">
    <h2>2. –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å</h2>

    <div class="style-btns">
      <button onclick="selectStyle('oil')" id="btn-oil" class="active">–ö–∞—Ä—Ç–∏–Ω–∞ –º–∞—Å–ª–æ–º</button>
      <button onclick="selectStyle('anime')" id="btn-anime">–ê–Ω–∏–º–µ-–ø–æ—Ä—Ç—Ä–µ—Ç</button>
      <button onclick="selectStyle('poster')" id="btn-poster">–ö–∏–Ω–æ-–ø–æ—Å—Ç–µ—Ä</button>
      <button onclick="selectStyle('classic')" id="btn-classic">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ö—É–¥–æ–∂–Ω–∏–∫</button>
    </div>

    <textarea id="extra" placeholder="–¢–µ–∫—Å—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" 
      style="width:100%;margin-top:12px;padding:12px;border-radius:12px;background:#1c2036;color:white;border:1px solid #333;"></textarea>

    <button onclick="generate()">–°–¥–µ–ª–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–æ–π</button>
    <p id="error" style="color:#ff6b6b;margin-top:10px"></p>
  </div>

  <!-- –ë–õ–û–ö 3 -->
  <div class="block">
    <h2>–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h2>
    <div id="result" style="min-height:150px;opacity:.6">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Ä—Ç—Ä–µ—Ç.</div>
  </div>

</div>

<script>
let CURRENT_STYLE = "oil";

function selectStyle(s) {
  CURRENT_STYLE = s;
  document.querySelectorAll(".style-btns button").forEach(b => b.classList.remove("active"));
  document.getElementById("btn-" + s).classList.add("active");
}


// ---------------------------------------------------------
// üî• –§–∏–∫—Å HTTP 413 ‚Äî —É–º–µ–Ω—å—à–∞–µ–º —Ñ–æ—Ç–æ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
// ---------------------------------------------------------
function fileToDataUrl(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    const img = new Image();

    reader.onload = (e) => {
      img.onload = () => {
        const maxSide = 1024; // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä

        let w = img.width;
        let h = img.height;

        if (w > h && w > maxSide) {
          h = Math.round(h * maxSide / w);
          w = maxSide;
        } else if (h >= w && h > maxSide) {
          w = Math.round(w * maxSide / h);
          h = maxSide;
        }

        const canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, w, h);

        try {
          const dataUrl = canvas.toDataURL("image/jpeg", 0.9);
          resolve(dataUrl);
        } catch (err) {
          reject(err);
        }
      };

      img.onerror = reject;
      img.src = e.target.result;
    };

    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}


// ---------------------------------------------------------
// üî• –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
// ---------------------------------------------------------
async function generate() {
  document.getElementById("error").innerText = "";
  document.getElementById("result").innerHTML = "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...";

  let imgData = null;

  const file = document.getElementById("photo").files[0];
  if (file) {
    imgData = await fileToDataUrl(file);
  }

  const body = {
    style: CURRENT_STYLE,
    extra: document.getElementById("extra").value || "",
    photo: imgData
  };

  try {
    const res = await fetch("/api/generate", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    const data = await res.json();

    if (!res.ok) {
      document.getElementById("error").innerText = "–û—à–∏–±–∫–∞: " + (data.error || data.message);
      document.getElementById("result").innerHTML = "";
      return;
    }

    if (data.image) {
      document.getElementById("result").innerHTML = `<img src="${data.image}" />`;
    } else {
      document.getElementById("result").innerHTML = "–û—à–∏–±–∫–∞: –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è";
    }

  } catch (err) {
    document.getElementById("error").innerText = "–û—à–∏–±–∫–∞: " + err.message;
    document.getElementById("result").innerHTML = "";
  }
}
</script>

</body>
</html>
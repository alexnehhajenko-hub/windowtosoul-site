<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>WindowToSoul ‚Ä¢ AI Photo ‚Üí Artwork</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="assets/style.css" />
  </head>
  <body>
    <div class="page">
      <header class="page-header">
        <div class="logo">ü™ü WindowToSoul</div>
        <div class="header-tagline">
          –û–Ω–ª–∞–π–Ω-–ø–æ—Ä—Ç—Ä–µ—Ç ‚Ä¢ AI —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è –ø–æ —Ñ–æ—Ç–æ
        </div>
      </header>

      <main class="layout">
        <!-- –õ–µ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞: —Ñ–æ—Ä–º–∞ -->
        <section class="card card-form">
          <h1 class="card-title">üé® AI Photo ‚Üí Artwork</h1>
          <p class="card-subtitle">
            –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ, –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å ‚Äî –∏ –ø–æ–ª—É—á–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω—É, –≥–æ—Ç–æ–≤—É—é –∫
            –ø–µ—á–∞—Ç–∏ –∏ —Å—Ç–æ—Ä–∏—Å.
          </p>

          <form id="art-form">
            <!-- –®–∞–≥ 1: —Ñ–æ—Ç–æ -->
            <div class="step">
              <h2 class="step-title">1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ</h2>
              <p class="step-hint">
                –õ—É—á—à–µ –≤—Å–µ–≥–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Ä—Ç—Ä–µ—Ç –ø–æ –ø–ª–µ—á–∏, –ø—Ä–∏ —Ö–æ—Ä–æ—à–µ–º –æ—Å–≤–µ—â–µ–Ω–∏–∏.
              </p>

              <label class="file-input">
                <span class="file-button">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</span>
                <span id="file-name" class="file-name">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
                <input
                  id="photo-input"
                  type="file"
                  accept="image/*"
                  hidden
                />
              </label>

              <div id="photo-preview" class="photo-preview hidden">
                <img id="photo-img" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ" />
              </div>
            </div>

            <!-- –®–∞–≥ 2: —Å—Ç–∏–ª—å -->
            <div class="step">
              <h2 class="step-title">2. –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å</h2>
              <div class="style-grid" id="style-buttons">
                <button
                  type="button"
                  class="style-btn style-btn--active"
                  data-style="oil"
                >
                  –ö–∞—Ä—Ç–∏–Ω–∞ –º–∞—Å–ª–æ–º
                </button>
                <button
                  type="button"
                  class="style-btn"
                  data-style="anime"
                >
                  –ê–Ω–∏–º–µ-–ø–æ—Ä—Ç—Ä–µ—Ç
                </button>
                <button
                  type="button"
                  class="style-btn"
                  data-style="poster"
                >
                  –ö–∏–Ω–æ-–ø–æ—Å—Ç–µ—Ä
                </button>
                <button
                  type="button"
                  class="style-btn"
                  data-style="classic"
                >
                  –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ö—É–¥–æ–∂–Ω–∏–∫
                </button>
              </div>
            </div>

            <!-- –®–∞–≥ 3: –¥–æ–ø. —Ç–µ–∫—Å—Ç -->
            <div class="step">
              <h2 class="step-title">3. –°–≤–æ–π —Ç–µ–∫—Å—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</h2>
              <p class="step-hint">
                –ú–æ–∂–Ω–æ –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å –∞—Ç–º–æ—Å—Ñ–µ—Ä—ã: ‚Äú–≤–µ—á–µ—Ä–Ω–µ–µ —Ç—ë–ø–ª–æ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ‚Äù, ‚Äú–≤
                —Å—Ç–∏–ª–µ 80-—Ö‚Äù, ‚Äú–º—è–≥–∫–∏–µ –ø–∞—Å—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–Ω–∞‚Äù –∏ —Ç.–ø.
              </p>
              <textarea
                id="prompt-input"
                class="prompt-input"
                rows="3"
                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–¥–µ–ª–∞—Ç—å –Ω–µ–º–Ω–æ–≥–æ –º–æ–ª–æ–∂–µ, —Ç—ë–ø–ª—ã–π —Å–≤–µ—Ç, –º—è–≥–∫–∏–µ —Ç–µ–Ω–∏"
              ></textarea>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∞ -->
            <div class="step step-submit">
              <button id="generate-btn" class="primary-btn" type="submit">
                <span id="btn-label">–°–¥–µ–ª–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–æ–π</span>
                <span id="btn-spinner" class="btn-spinner hidden">‚è≥</span>
              </button>
              <p id="status" class="status-line"></p>
            </div>
          </form>
        </section>

        <!-- –ü—Ä–∞–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞: —Ä–µ–∑—É–ª—å—Ç–∞—Ç -->
        <section class="card card-result">
          <h2 class="card-title">–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h2>
          <p class="card-subtitle">
            –ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—é–¥–∞ –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç—Å—è –ø–æ—Ä—Ç—Ä–µ—Ç –≤ –≤—ã—Å–æ–∫–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏.
          </p>

          <div id="result-container" class="result-box">
            <div class="result-placeholder">
              –ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Ä—Ç—Ä–µ—Ç –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.
            </div>
          </div>

          <a
            id="download-link"
            class="download-btn hidden"
            href="#"
            download="windowtosoul-portrait.png"
          >
            ‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –≤ –≤—ã—Å–æ–∫–æ–º –∫–∞—á–µ—Å—Ç–≤–µ
          </a>

          <p class="hint-small">
            –í MVP-–≤–µ—Ä—Å–∏–∏ –≤—Å—ë –±–µ—Å–ø–ª–∞—Ç–Ω–æ. –í –±–æ–µ–≤–æ–º —Ä–µ–∂–∏–º–µ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –æ–ø–ª–∞—Ç–∞ –ø–µ—Ä–µ–¥
            —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ–º.
          </p>
        </section>
      </main>

      <footer class="page-footer">
        WindowToSoul ‚Ä¢ —Ç–µ—Å—Ç–æ–≤—ã–π —Å—Ç–µ–Ω–¥ –¥–ª—è 4 —Å—Ç–∏–ª–µ–π (Replicate + FLUX)
      </footer>
    </div>

    <script>
      (function () {
        const form = document.getElementById("art-form");
        const photoInput = document.getElementById("photo-input");
        const fileNameEl = document.getElementById("file-name");
        const photoPreview = document.getElementById("photo-preview");
        const photoImg = document.getElementById("photo-img");
        const styleButtons = document.getElementById("style-buttons");
        const promptInput = document.getElementById("prompt-input");
        const statusEl = document.getElementById("status");
        const btn = document.getElementById("generate-btn");
        const btnLabel = document.getElementById("btn-label");
        const btnSpinner = document.getElementById("btn-spinner");
        const resultContainer = document.getElementById("result-container");
        const downloadLink = document.getElementById("download-link");

        let currentStyle = "oil";
        let currentFile = null;

        const styleBasePrompts = {
          oil: "oil painting portrait of the person from the photo, rich brush strokes, warm cinematic light, highly detailed, 4k resolution",
          anime:
            "anime style portrait of the person from the photo, clean lines, soft lighting, detailed illustration, trending on pixiv",
          poster:
            "cinematic movie poster style portrait of the person from the photo, dramatic lighting, epic atmosphere, ultra detailed, 4k",
          classic:
            "classic painter style portrait of the person from the photo, inspired by Rembrandt and old masters, warm tones, detailed brushwork, museum quality",
        };

        // –ö–ª–∏–∫ –ø–æ —Å—Ç–∏–ª—è–º
        styleButtons.addEventListener("click", (e) => {
          const btn = e.target.closest(".style-btn");
          if (!btn) return;
          [...styleButtons.querySelectorAll(".style-btn")].forEach((b) =>
            b.classList.toggle("style-btn--active", b === btn)
          );
          currentStyle = btn.dataset.style;
        });

        // –ö–ª–∏–∫ –ø–æ "–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª"
        document
          .querySelector(".file-input")
          .addEventListener("click", () => photoInput.click());

        // –í—ã–±–æ—Ä —Ñ–∞–π–ª–∞
        photoInput.addEventListener("change", () => {
          const [file] = photoInput.files || [];
          currentFile = file || null;

          if (!file) {
            fileNameEl.textContent = "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω";
            photoPreview.classList.add("hidden");
            photoImg.src = "";
            return;
          }

          fileNameEl.textContent = file.name;

          const url = URL.createObjectURL(file);
          photoImg.onload = () => URL.revokeObjectURL(url);
          photoImg.src = url;
          photoPreview.classList.remove("hidden");
        });

        function setLoading(isLoading) {
          if (isLoading) {
            btn.disabled = true;
            btnLabel.textContent = "–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º‚Ä¶";
            btnSpinner.classList.remove("hidden");
          } else {
            btn.disabled = false;
            btnLabel.textContent = "–°–¥–µ–ª–∞—Ç—å –∫–∞—Ä—Ç–∏–Ω–æ–π";
            btnSpinner.classList.add("hidden");
          }
        }

        function setStatus(message, isError = false) {
          statusEl.textContent = message || "";
          statusEl.classList.toggle("status-line--error", !!isError);
        }

        function fileToDataUrl(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });
        }

        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          setStatus("");

          if (!currentFile) {
            setStatus("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ (–ø–æ—Ä—Ç—Ä–µ—Ç).", true);
            return;
          }

          setLoading(true);

          try {
            const basePrompt = styleBasePrompts[currentStyle] || "";
            const extra = (promptInput.value || "").trim();
            const finalPrompt = extra ? basePrompt + ". " + extra : basePrompt;

            const imageDataUrl = currentFile
              ? await fileToDataUrl(currentFile)
              : null;

            const response = await fetch("/api/generate", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                prompt: finalPrompt,
                imageDataUrl,
              }),
            });

            const data = await response.json().catch(() => ({}));

            if (!response.ok) {
              throw new Error(data.error || data.details || "HTTP " + response.status);
            }

            const imageUrl = data.imageUrl || data.output;
            if (!imageUrl) {
              throw new Error("–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.");
            }

            resultContainer.innerHTML = "";
            const img = document.createElement("img");
            img.src = imageUrl;
            img.alt = "–†–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏";
            img.className = "result-image";
            resultContainer.appendChild(img);

            downloadLink.href = imageUrl;
            downloadLink.classList.remove("hidden");

            setStatus("–ì–æ—Ç–æ–≤–æ! –ú–æ–∂–Ω–æ —Å–∫–∞—á–∏–≤–∞—Ç—å –ø–æ—Ä—Ç—Ä–µ—Ç.");
          } catch (err) {
            console.error(err);
            setStatus(
              "–û—à–∏–±–∫–∞: " + (err && err.message ? err.message : "Generation failed"),
              true
            );
          } finally {
            setLoading(false);
          }
        });
      })();
    </script>
  </body>
</html>